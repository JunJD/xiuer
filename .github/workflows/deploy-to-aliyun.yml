name: Deploy Xiuer to Aliyun

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          echo "ðŸ” æ£€æŸ¥å¿…è¦çš„å¯†é’¥é…ç½®..."
          [[ -z "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" ]] && echo "âŒ Missing ALIYUN_REGISTRY_USERNAME" && exit 1
          [[ -z "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" ]] && echo "âŒ Missing ALIYUN_REGISTRY_PASSWORD" && exit 1
          [[ -z "${{ secrets.ECS_HOST }}" ]] && echo "âŒ Missing ECS_HOST" && exit 1
          [[ -z "${{ secrets.ECS_USERNAME }}" ]] && echo "âŒ Missing ECS_USERNAME" && exit 1
          [[ -z "${{ secrets.ECS_SSH_KEY }}" ]] && echo "âŒ Missing ECS_SSH_KEY" && exit 1
          [[ -z "${{ secrets.DATABASE_URL }}" ]] && echo "âŒ Missing DATABASE_URL" && exit 1
          [[ -z "${{ secrets.ACCESS_SECRET_KEY }}" ]] && echo "âŒ Missing ACCESS_SECRET_KEY" && exit 1
          [[ -z "${{ secrets.RESET_PASSWORD_SECRET_KEY }}" ]] && echo "âŒ Missing RESET_PASSWORD_SECRET_KEY" && exit 1
          [[ -z "${{ secrets.VERIFICATION_SECRET_KEY }}" ]] && echo "âŒ Missing VERIFICATION_SECRET_KEY" && exit 1
          echo "âœ… æ‰€æœ‰å¿…è¦çš„å¯†é’¥éƒ½å·²é…ç½®"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker to use Aliyun mirror
        run: |
          echo "ðŸ”§ Configuring Docker mirror for the runner..."
          sudo mkdir -p /etc/docker
          echo '{"registry-mirrors": ["https://hylq3tyc.mirror.aliyuncs.com"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          echo "âœ… Docker mirror configured."

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY_URL }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi_backend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:${{ github.sha }}
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./nextjs-frontend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:${{ github.sha }}
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            API_BASE_URL=${{ secrets.API_BASE_URL }}

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Deploy to Aliyun ECS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT }}
          script: |
            set -e
            echo "ðŸš€ å¼€å§‹éƒ¨ç½²..."
            APP_DIR="/app/xiuer"
            mkdir -p $APP_DIR
            cd $APP_DIR

            # --- 1. åˆ›å»º Nginx é…ç½®æ–‡ä»¶ ---
            echo "ðŸ”§ åˆ›å»º nginx.conf..."
            mkdir -p ./nginx
            cat > ./nginx/default.conf << 'EOL'
            server {
                listen 80;
                server_name ${{ secrets.ECS_HOST }};

                location / {
                    proxy_pass http://frontend:3000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                location /api/ {
                    proxy_pass http://backend:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            EOL

            # --- 2. åˆ›å»º docker-compose.prod.yml ---
            echo "ðŸ”§ åˆ›å»º docker-compose.prod.yml..."
            cat > docker-compose.prod.yml << 'EOL'
            services:
              db:
                image: postgres:latest
                restart: always
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                environment:
                  - POSTGRES_USER=${{ secrets.DB_USER }}
                  - POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
                  - POSTGRES_DB=${{ secrets.DB_NAME }}
                networks:
                  - my_network

              backend:
                image: ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:${{ github.sha }}
                restart: always
                depends_on:
                  - db
                environment:
                  - DATABASE_URL=postgresql+asyncpg://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@db:5432/${{ secrets.DB_NAME }}
                  - ACCESS_SECRET_KEY=${{ secrets.ACCESS_SECRET_KEY }}
                  - RESET_PASSWORD_SECRET_KEY=${{ secrets.RESET_PASSWORD_SECRET_KEY }}
                  - VERIFICATION_SECRET_KEY=${{ secrets.VERIFICATION_SECRET_KEY }}
                  - CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
                  - AUTO_MIGRATE=true
                networks:
                  - my_network

              frontend:
                image: ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:${{ github.sha }}
                restart: always
                networks:
                  - my_network

              nginx:
                image: nginx:latest
                restart: always
                ports:
                  - "80:80"
                volumes:
                  - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
                depends_on:
                  - frontend
                  - backend
                networks:
                  - my_network

            volumes:
              postgres_data:

            networks:
              my_network:
                driver: bridge
            EOL

            # --- 3. çŽ¯å¢ƒå‡†å¤‡å’Œç™»å½• ---
            echo "ðŸ”„ é‡å¯ Docker æœåŠ¡ä»¥ç¡®ä¿çŽ¯å¢ƒç¨³å®š..."
            sudo systemctl daemon-reload
            sudo systemctl restart docker
            echo "â³ ç­‰å¾… Docker æœåŠ¡å®Œå…¨å¯åŠ¨..."
            sleep 3
            
            echo "ðŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨ä»“åº“..."
            docker login --username "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" --password "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" ${{ secrets.ALIYUN_REGISTRY_URL }}

            # --- 4. åªæ‹‰å–è‡ªå®šä¹‰é•œåƒï¼Œè®© docker compose è‡ªåŠ¨å¤„ç†åŸºç¡€é•œåƒ ---
            echo "ðŸ“¦ æ‹‰å–æ‰€æœ‰æœ€æ–°é•œåƒ..."
            docker compose -f docker-compose.prod.yml pull

            # --- 5. å¯åŠ¨æœåŠ¡ (docker compose ä¼šè‡ªåŠ¨æ‹‰å–åŸºç¡€é•œåƒ) ---
            echo "ðŸš€ åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°ç‰ˆæœ¬..."
            docker compose -f docker-compose.prod.yml down --remove-orphans
            docker compose -f docker-compose.prod.yml up -d --pull=always
            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆï¼"

            # --- 6. æ¸…ç†å·¥ä½œ ---
            echo "ðŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker é•œåƒ..."
            docker image prune -f

            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ðŸ“± å‰ç«¯è®¿é—®åœ°å€: http://${{ secrets.ECS_HOST }}"
            echo "ðŸ”— åŽç«¯ API æ–‡æ¡£: http://${{ secrets.ECS_HOST }}/docs"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi 