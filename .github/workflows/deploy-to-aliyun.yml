name: Deploy Xiuer to Aliyun

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…è¦çš„å¯†é’¥é…ç½®..."
          [[ -z "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" ]] && echo "âŒ Missing ALIYUN_REGISTRY_USERNAME" && exit 1
          [[ -z "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" ]] && echo "âŒ Missing ALIYUN_REGISTRY_PASSWORD" && exit 1
          [[ -z "${{ secrets.ECS_HOST }}" ]] && echo "âŒ Missing ECS_HOST" && exit 1
          [[ -z "${{ secrets.ECS_USERNAME }}" ]] && echo "âŒ Missing ECS_USERNAME" && exit 1
          [[ -z "${{ secrets.ECS_SSH_KEY }}" ]] && echo "âŒ Missing ECS_SSH_KEY" && exit 1
          [[ -z "${{ secrets.DATABASE_URL }}" ]] && echo "âŒ Missing DATABASE_URL" && exit 1
          [[ -z "${{ secrets.ACCESS_SECRET_KEY }}" ]] && echo "âŒ Missing ACCESS_SECRET_KEY" && exit 1
          [[ -z "${{ secrets.RESET_PASSWORD_SECRET_KEY }}" ]] && echo "âŒ Missing RESET_PASSWORD_SECRET_KEY" && exit 1
          [[ -z "${{ secrets.VERIFICATION_SECRET_KEY }}" ]] && echo "âŒ Missing VERIFICATION_SECRET_KEY" && exit 1
          echo "âœ… æ‰€æœ‰å¿…è¦çš„å¯†é’¥éƒ½å·²é…ç½®"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY_URL }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi_backend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:${{ github.sha }}
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./nextjs-frontend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:${{ github.sha }}
            ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            API_BASE_URL=${{ secrets.API_BASE_URL }}

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Deploy to ECS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          debug: true
          script: |
            set -e
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²å°çº¢ä¹¦æ•°æ®åˆ†æå¹³å°..."
            
            # åˆ›å»ºåº”ç”¨ç›®å½•
            mkdir -p /app/xiuer
            cd /app/xiuer
            
            # æ£€æŸ¥ Docker å’Œ Docker Compose æ˜¯å¦å®‰è£…
            if ! command -v docker &> /dev/null; then
                echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
                exit 1
            fi
            
            if ! command -v docker-compose &> /dev/null; then
                echo "âŒ Docker Compose æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker Compose"
                exit 1
            fi
            
            echo "âœ… Docker ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
            
            # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨ä»“åº“
            echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨ä»“åº“..."
            docker login --username ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password ${{ secrets.ALIYUN_REGISTRY_PASSWORD }} ${{ secrets.ALIYUN_REGISTRY_URL }}
            
            # åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„ docker-compose.yml
            cat > docker-compose.prod.yml << 'EOL'
            version: '3.8'
            
            services:
              backend:
                image: ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/backend:${{ github.sha }}
                restart: always
                environment:
                  - DATABASE_URL=${{ secrets.DATABASE_URL }}
                  - ACCESS_SECRET_KEY=${{ secrets.ACCESS_SECRET_KEY }}
                  - RESET_PASSWORD_SECRET_KEY=${{ secrets.RESET_PASSWORD_SECRET_KEY }}
                  - VERIFICATION_SECRET_KEY=${{ secrets.VERIFICATION_SECRET_KEY }}
                  - GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
                  - GITHUB_REPO_OWNER=${{ secrets.GITHUB_REPO_OWNER }}
                  - GITHUB_REPO_NAME=${{ secrets.GITHUB_REPO_NAME }}
                  - REDIS_URL=${{ secrets.REDIS_URL || 'redis://redis:6379' }}
                  - AUTO_MIGRATE=true
                  - LOG_LEVEL=INFO
                ports:
                  - "8000:8000"
                depends_on:
                  - db
                  - redis
                networks:
                  - xiuer_network
                deploy:
                  resources:
                    limits:
                      memory: 512M
                    reservations:
                      memory: 256M
              
              frontend:
                image: ${{ secrets.ALIYUN_REGISTRY_URL }}/xiuer_2/frontend:${{ github.sha }}
                restart: always
                environment:
                  - NODE_ENV=production
                  - API_BASE_URL=${{ secrets.API_BASE_URL || 'http://backend:8000' }}
                  - NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
                ports:
                  - "3000:3000"
                depends_on:
                  - backend
                networks:
                  - xiuer_network
                deploy:
                  resources:
                    limits:
                      memory: 256M
                    reservations:
                      memory: 128M
              
              db:
                image: postgres:17-alpine
                restart: always
                environment:
                  - POSTGRES_USER=${{ secrets.POSTGRES_USER || 'postgres' }}
                  - POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
                  - POSTGRES_DB=${{ secrets.POSTGRES_DB || 'xiuer' }}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                ports:
                  - "5432:5432"
                networks:
                  - xiuer_network
                deploy:
                  resources:
                    limits:
                      memory: 256M
                    reservations:
                      memory: 128M
              
              redis:
                image: redis:7-alpine
                restart: always
                command: redis-server --appendonly yes
                volumes:
                  - redis_data:/data
                ports:
                  - "6379:6379"
                networks:
                  - xiuer_network
                deploy:
                  resources:
                    limits:
                      memory: 128M
                    reservations:
                      memory: 64M
              
              # Nginx åå‘ä»£ç† (å¯é€‰)
              nginx:
                image: nginx:alpine
                restart: always
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./ssl:/etc/nginx/ssl:ro
                depends_on:
                  - frontend
                  - backend
                networks:
                  - xiuer_network
                deploy:
                  resources:
                    limits:
                      memory: 64M
                    reservations:
                      memory: 32M

            volumes:
              postgres_data:
              redis_data:

            networks:
              xiuer_network:
                driver: bridge
            EOL
            
            # åˆ›å»º Nginx é…ç½®æ–‡ä»¶
            cat > nginx.conf << 'EOL'
            events {
                worker_connections 1024;
            }
            
            http {
                upstream frontend {
                    server frontend:3000;
                }
                
                upstream backend {
                    server backend:8000;
                }
                
                server {
                    listen 80;
                    server_name _;
                    
                    # å‰ç«¯è·¯ç”±
                    location / {
                        proxy_pass http://frontend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                    
                    # åç«¯ API è·¯ç”±
                    location /api/ {
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                    
                    # åç«¯æ–‡æ¡£è·¯ç”±
                    location /docs {
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                    
                    location /openapi.json {
                        proxy_pass http://backend;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                }
            }
            EOL
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°çš„ Docker é•œåƒ..."
            docker-compose -f docker-compose.prod.yml pull
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§ç‰ˆæœ¬å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml down --remove-orphans
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°ç‰ˆæœ¬å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose -f docker-compose.prod.yml ps
            
            # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
            echo "ğŸ¥ æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€..."
            for i in {1..10}; do
                if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                    echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
                    break
                fi
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/10)"
                sleep 10
            done
            
            # æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€
            echo "ğŸ¥ æ£€æŸ¥å‰ç«¯å¥åº·çŠ¶æ€..."
            for i in {1..10}; do
                if curl -f http://localhost:3000 > /dev/null 2>&1; then
                    echo "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
                    break
                fi
                echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨... ($i/10)"
                sleep 10
            done
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“± å‰ç«¯è®¿é—®åœ°å€: http://${{ secrets.ECS_HOST }}"
            echo "ğŸ”— åç«¯ API æ–‡æ¡£: http://${{ secrets.ECS_HOST }}/docs"
            
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ“± å‰ç«¯è®¿é—®åœ°å€: http://${{ secrets.ECS_HOST }}"
            echo "ğŸ”— åç«¯ API æ–‡æ¡£: http://${{ secrets.ECS_HOST }}/docs"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi 