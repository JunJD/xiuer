name: Deploy to Aliyun Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create .env file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          script: |
            echo "Creating .env file..."
            cd /root/xiuer
            cat <<EOF > .env
            # Database credentials
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}

            # JWT Secret
            ACCESS_SECRET_KEY=${{ secrets.ACCESS_SECRET_KEY }}
            EOF
            echo ".env file created successfully."

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          script: |
            echo "Starting deployment..."
            cd /root/xiuer
            echo "Pulling latest code from main branch..."
            git pull origin main
            echo "Deploying application using Makefile..."
            make deploy
            echo "Deployment finished!" 