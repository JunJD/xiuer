name: Test XHS Access

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-xhs-access:
    runs-on: ubuntu-latest
    
    env:
      COOKIES: ${{ secrets.XHS_COOKIES }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          
      - name: Install Python dependencies
        working-directory: ./Spider_XHS
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Install Node.js dependencies
        working-directory: ./Spider_XHS
        run: |
          npm install
          
      - name: Create .env file
        working-directory: ./Spider_XHS
        run: |
          echo "COOKIES=${{ secrets.XHS_COOKIES }}" > .env
          
      - name: Create test script
        working-directory: ./Spider_XHS
        run: |
          cat > test_xhs_access.py << 'EOF'
          import os
          import sys
          from loguru import logger
          from apis.xhs_pc_apis import XHS_Apis
          from xhs_utils.common_util import init
          
          def test_xhs_access():
              """æµ‹è¯•å°çº¢ä¹¦æœåŠ¡å¯è®¿é—®æ€§"""
              try:
                  # åˆå§‹åŒ–
                  cookies_str, base_path = init()
                  
                  if not cookies_str:
                      logger.error("COOKIES çŽ¯å¢ƒå˜é‡æœªè®¾ç½®")
                      return False
                      
                  logger.info(f"Cookie é•¿åº¦: {len(cookies_str) if cookies_str else 0}")
                  
                  # åˆ›å»ºAPIå®žä¾‹
                  xhs_apis = XHS_Apis()
                  
                  # æµ‹è¯•ä¸€ä¸ªç®€å•çš„æœç´¢è¯·æ±‚
                  logger.info("å¼€å§‹æµ‹è¯•å°çº¢ä¹¦æœç´¢åŠŸèƒ½...")
                  success, msg, notes = xhs_apis.search_some_note(
                      query="æµ‹è¯•", 
                      require_num=1, 
                      cookies_str=cookies_str,
                      sort_type_choice=0,
                      note_type=0,
                      note_time=0,
                      note_range=0,
                      pos_distance=0,
                      geo=None,
                      proxies=None
                  )
                  
                  if success:
                      logger.success(f"âœ… å°çº¢ä¹¦æœåŠ¡å¯è®¿é—®ï¼æœç´¢åˆ° {len(notes) if notes else 0} ä¸ªç»“æžœ")
                      return True
                  else:
                      logger.error(f"âŒ å°çº¢ä¹¦æœåŠ¡è®¿é—®å¤±è´¥: {msg}")
                      return False
                      
              except Exception as e:
                  logger.error(f"âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
                  return False
          
          if __name__ == "__main__":
              logger.info("ðŸš€ å¼€å§‹æµ‹è¯•å°çº¢ä¹¦æœåŠ¡å¯è®¿é—®æ€§...")
              result = test_xhs_access()
              
              if result:
                  logger.success("ðŸŽ‰ æµ‹è¯•å®Œæˆï¼šå°çº¢ä¹¦æœåŠ¡å¯æ­£å¸¸è®¿é—®")
                  sys.exit(0)
              else:
                  logger.error("ðŸ’¥ æµ‹è¯•å¤±è´¥ï¼šå°çº¢ä¹¦æœåŠ¡æ— æ³•è®¿é—®")
                  sys.exit(1)
          EOF
          
      - name: Run XHS access test
        working-directory: ./Spider_XHS
        run: |
          python test_xhs_access.py
          
      - name: Test network connectivity
        run: |
          echo "=== ç½‘ç»œè¿žæŽ¥æµ‹è¯• ==="
          ping -c 3 www.xiaohongshu.com || echo "Ping å¤±è´¥"
          echo ""
          echo "=== DNS è§£æžæµ‹è¯• ==="
          nslookup www.xiaohongshu.com || echo "DNS è§£æžå¤±è´¥"
          echo ""
          echo "=== HTTP è®¿é—®æµ‹è¯• ==="
          curl -I https://www.xiaohongshu.com --max-time 10 || echo "HTTP è®¿é—®å¤±è´¥"
          
      - name: Clean up test files
        working-directory: ./Spider_XHS
        if: always()
        run: |
          rm -f test_xhs_access.py
          rm -f .env 